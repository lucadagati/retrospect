' SPDX-License-Identifier: CC-BY-4.0
' Copyright Â© 2025 Wasmbed contributors

@startuml
title Device & Application Error Handling

skinparam wrapMessageWidth 200
skinparam sequenceMessageAlign center
skinparam sequenceArrowThickness 2
skinparam sequenceLifeLineBackgroundColor #E8F4FD
skinparam sequenceActorBackgroundColor #D4E6F1
skinparam sequenceParticipantBackgroundColor #F8F9FA
skinparam direction top to bottom

actor "IoT Device" as MCU #LightBlue
participant "TLS Client" as TLS_CLIENT #LightGreen
participant "Gateway Server" as GATEWAY #LightCoral
participant "Device Manager" as DEVICE_MGR #LightYellow
participant "Kubernetes API" as K8S_API #LightGray

== Enrollment Error Handling ==

alt **Enrollment Failure**
    DEVICE_MGR -> GATEWAY : **Enrollment Failed**
    note right : Invalid device type\nUnsupported device capabilities\nX.509 v3 certificate validation failed\nDuplicate device ID
    
    GATEWAY -> TLS_CLIENT : **Error Response**
    note right : CBOR encoded error\nError code: ENROLLMENT_FAILED\nError message\nRetry information\nCertificate issues
    
    TLS_CLIENT -> MCU : **Enrollment Error**
    note right : Log error message\nWait before retry\nUpdate device status\nCheck certificate validity
end

== Connection Error Handling ==

alt **Connection Lost**
    GATEWAY -> DEVICE_MGR : **Connection Lost**
    note right : TCP connection closed\nTLS 1.3 session terminated\nDevice unreachable\nDevice offline
    
    DEVICE_MGR -> K8S_API : **Update Device Status**
    note right : PATCH device resource\nStatus.phase: Disconnected\nStatus.last_heartbeat: null\nStatus.device_status: Stopped\nStatus.error: Connection lost
end

== Application Error Handling ==

alt **Compilation Failure**
    GATEWAY -> TLS_CLIENT : **Compilation Error**
    note right : Rust compilation failed\nSyntax errors detected\nDependency issues\nTarget architecture incompatible
    
    TLS_CLIENT -> MCU : **Compilation Failed**
    note right : Error response\nError details\nSuggestions for fixes\nRetry options
end

alt **Deployment Failure**
    MCU -> GATEWAY : **Deployment Error**
    note right : WASM binary invalid\nMemory allocation failed\nRuntime initialization error\nDevice capability mismatch
    
    GATEWAY -> DEVICE_MGR : **Deployment Failed**
    note right : Error details\nDevice status\nFailure reason\nRetry information
    
    DEVICE_MGR -> K8S_API : **Update Application Status**
    note right : PATCH application resource\nStatus.phase: Failed\nStatus.error: error_details\nStatus.retry_count: incremented
end

alt **Runtime Error**
    MCU -> GATEWAY : **Runtime Error**
    note right : WASM execution failed\nMemory access violation\nFunction call error\nResource exhaustion
    
    GATEWAY -> DEVICE_MGR : **Runtime Error Report**
    note right : Error details\nStack trace\nResource usage\nRecovery options
    
    DEVICE_MGR -> K8S_API : **Update Application Status**
    note right : PATCH application resource\nStatus.phase: Error\nStatus.error: runtime_error\nStatus.health: unhealthy
end

== Certificate Error Handling ==

alt **Certificate Issues**
    DEVICE_MGR -> GATEWAY : **Certificate Validation Failed**
    note right : X.509 v3 certificate invalid\nCertificate chain broken\nSignature verification failed\nCertificate expired
    
    GATEWAY -> TLS_CLIENT : **Certificate Error**
    note right : Device certificate invalid\nCannot authenticate device\nReject enrollment request\nRequest certificate renewal
    
    TLS_CLIENT -> MCU : **Certificate Error Response**
    note right : CBOR encoded error\nError code: CERTIFICATE_INVALID\nError message: Certificate validation failed\nAction: Renew device certificate
end

note over MCU, K8S_API
  **Error Handling Complete**
  All error scenarios are handled
  with appropriate recovery actions
end note

@enduml
