' SPDX-License-Identifier: CC-BY-4.0
' Copyright Â© 2025 Wasmbed contributors

@startuml
title Application Deployment - Gateway & Device Deployment

skinparam wrapMessageWidth 200
skinparam sequenceMessageAlign center
skinparam sequenceArrowThickness 2
skinparam sequenceLifeLineBackgroundColor #E8F4FD
skinparam sequenceActorBackgroundColor #D4E6F1
skinparam sequenceParticipantBackgroundColor #F8F9FA
skinparam direction top to bottom

participant "API Server" as API_SERVER #LightCoral
participant "Gateway Server" as GATEWAY #LightPink
participant "WASM Runtime" as WASM_RT #LightCyan
participant "IoT Device" as DEVICE #LightSteelBlue

== Gateway Preparation ==

API_SERVER -> GATEWAY : **Deploy Application**
note right : Application metadata\nWASM binary (base64)\nTarget device IDs\nDeployment configuration\nTLS encrypted request

GATEWAY -> GATEWAY : **Prepare WASM Runtime**
note right : Initialize wasmtime engine\nPrepare WASM module\nValidate binary format\nSet up execution context

GATEWAY -> WASM_RT : **Load WASM Module**
note right : Parse WASM binary\nValidate module structure\nInitialize memory\nPrepare function exports\nSet up execution environment

WASM_RT -> WASM_RT : **WASM Module Validation**
note right : Validate WASM magic number\nCheck module structure\nVerify function signatures\nValidate memory layout\nCheck import/export compatibility

WASM_RT -> GATEWAY : **Module Loaded Successfully**
note right : WASM module ready\nFunction exports available\nMemory initialized\nExecution context prepared

== Device Communication ==

GATEWAY -> DEVICE : **TLS Connection**
note right : Connect to IoT device\nEstablish TLS 1.3 connection\nMutual authentication\nEncrypted channel ready

DEVICE -> DEVICE : **Prepare for Deployment**
note right : Initialize WASM runtime\nPrepare memory allocation\nSet up execution environment\nReady for binary transfer

GATEWAY -> DEVICE : **Send WASM Binary**
note right : CBOR encoded message\nWASM binary transfer\nApplication metadata\nDeployment instructions\nTLS encrypted transmission

DEVICE -> DEVICE : **Load WASM Application**
note right : Receive WASM binary\nParse CBOR message\nLoad into wasmtime runtime\nInitialize application context\nPrepare for execution

DEVICE -> DEVICE : **Execute WASM Application**
note right : Start WASM execution\nInitialize application state\nBegin main function\nMonitor execution status\nHandle runtime events

DEVICE -> GATEWAY : **Deployment Confirmation**
note right : CBOR encoded response\nStatus: Success\nApplication ID\nExecution status\nPerformance metrics

note over API_SERVER, DEVICE
  **Deployment Phase Complete**
  Application is successfully deployed
  and running on the device
end note

@enduml
