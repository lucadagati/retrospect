' SPDX-License-Identifier: CC-BY-4.0
' Copyright Â© 2025 Wasmbed contributors

@startuml
title Device Enrollment - Heartbeat & Monitoring

skinparam wrapMessageWidth 200
skinparam sequenceMessageAlign center
skinparam sequenceArrowThickness 2
skinparam sequenceLifeLineBackgroundColor #E8F4FD
skinparam sequenceActorBackgroundColor #D4E6F1
skinparam sequenceParticipantBackgroundColor #F8F9FA
skinparam direction top to bottom

actor "Arduino Nano 33 BLE" as MCU #LightBlue
participant "TLS Client" as TLS_CLIENT #LightGreen
participant "Gateway Server" as GATEWAY #LightCoral
participant "Renode Manager" as RENODE_MGR #LightYellow
participant "Kubernetes API" as K8S_API #LightGray

== Heartbeat Setup ==

MCU -> MCU : **Start Heartbeat Timer**
note right : Set interval: 30 seconds\nPrepare CBOR heartbeat message\nInitialize ARM Cortex-M4 metrics\nMonitor Renode status

MCU -> TLS_CLIENT : **Send Heartbeat**
note right : CBOR encoded heartbeat\nDevice ID\nTimestamp\nRenode status: Active\nARM Cortex-M4 metrics\nWASM runtime status

TLS_CLIENT -> GATEWAY : **Heartbeat Message**
note right : Encrypted heartbeat via TLS 1.3\nDevice status\nRenode performance metrics\nARM Cortex-M4 error counts\nWASM runtime health

GATEWAY -> RENODE_MGR : **Process Heartbeat**
note right : Validate device ID\nUpdate last heartbeat time\nCheck Renode device health\nProcess ARM Cortex-M4 metrics\nMonitor WASM runtime

RENODE_MGR -> K8S_API : **Update Device Heartbeat**
note right : PATCH device resource\nStatus.last_heartbeat: timestamp\nStatus.health: healthy\nStatus.renode_metrics: data\nStatus.wasm_runtime: ready

== Continuous Monitoring ==

loop **Every 30 seconds**
    MCU -> TLS_CLIENT : **Periodic Heartbeat**
    note right : CBOR encoded heartbeat\nDevice status\nPerformance metrics\nError counts
    
    TLS_CLIENT -> GATEWAY : **Heartbeat Message**
    note right : Encrypted heartbeat\nDevice health status\nRenode metrics\nWASM runtime status
    
    GATEWAY -> RENODE_MGR : **Process Heartbeat**
    note right : Update device status\nMonitor performance\nCheck health indicators
    
    RENODE_MGR -> K8S_API : **Update Device Status**
    note right : PATCH device resource\nStatus.last_heartbeat: timestamp\nStatus.health: healthy\nStatus.metrics: updated
end

note over MCU, K8S_API
  **Heartbeat Phase Active**
  Device is continuously monitored
  with 30-second heartbeat intervals
end note

@enduml
