' SPDX-License-Identifier: CC-BY-4.0
' Copyright Â© 2025 Wasmbed contributors

@startuml
title Device Enrollment - Enrollment Process

skinparam wrapMessageWidth 200
skinparam sequenceMessageAlign center
skinparam sequenceArrowThickness 2
skinparam sequenceLifeLineBackgroundColor #E8F4FD
skinparam sequenceActorBackgroundColor #D4E6F1
skinparam sequenceParticipantBackgroundColor #F8F9FA
skinparam direction top to bottom

actor "Arduino Nano 33 BLE" as MCU #LightBlue
participant "TLS Client" as TLS_CLIENT #LightGreen
participant "Gateway Server" as GATEWAY #LightCoral
participant "Renode Manager" as RENODE_MGR #LightYellow
participant "Kubernetes API" as K8S_API #LightGray

== Enrollment Request ==

TLS_CLIENT -> GATEWAY : **Enrollment Request**
note right : CBOR encoded message\nDevice type: Arduino Nano 33 BLE\nArchitecture: ARM Cortex-M4\nCapabilities: [wasm, tls, cbor]\nPublic key: DER encoded

GATEWAY -> RENODE_MGR : **Process Enrollment**
note right : Validate Renode device type\nCheck ARM Cortex-M4 capabilities\nVerify public key format\nGenerate unique device ID

RENODE_MGR -> K8S_API : **Create Device CRD**
note right : POST /apis/wasmbed.io/v1/namespaces/wasmbed/devices\nDevice metadata with Renode info\nARM Cortex-M4 specifications\nStatus: Pending

K8S_API -> RENODE_MGR : **Device CRD Created**
note right : HTTP 201 Created\nResource metadata\nLocation header\nResource version

== Enrollment Response ==

RENODE_MGR -> GATEWAY : **Enrollment Success**
note right : Renode device registered successfully\nDevice ID generated\nGateway assigned\nARM Cortex-M4 status updated

GATEWAY -> TLS_CLIENT : **Enrollment Response**
note right : CBOR encoded response\nStatus: Success\nDevice ID: uuid\nGateway info: 127.0.0.1:8081\nHeartbeat interval: 30s\nWASM runtime ready

TLS_CLIENT -> MCU : **Enrollment Complete**
note right : Renode device successfully enrolled\nARM Cortex-M4 ready for WASM deployment\nStart heartbeat timer\nInitialize WASM runtime

note over MCU, K8S_API
  **Enrollment Phase Complete**
  Device is now registered in Kubernetes
  and ready for application deployment
end note

@enduml
